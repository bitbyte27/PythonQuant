

```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
```


```python
stock_data = pd.read_csv('datacsv/002210.csv')
stock_data = stock_data.set_index('date')
```


```python
stock_data.head()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>close</th>
      <th>volume</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2008-1-30</th>
      <td>2.45</td>
      <td>2.62</td>
      <td>2.34</td>
      <td>2.62</td>
      <td>22961270</td>
    </tr>
    <tr>
      <th>2008-1-31</th>
      <td>2.57</td>
      <td>2.71</td>
      <td>2.47</td>
      <td>2.51</td>
      <td>12938149</td>
    </tr>
    <tr>
      <th>2008-2-1</th>
      <td>2.43</td>
      <td>2.43</td>
      <td>2.23</td>
      <td>2.23</td>
      <td>7567562</td>
    </tr>
    <tr>
      <th>2008-2-4</th>
      <td>2.39</td>
      <td>2.45</td>
      <td>2.30</td>
      <td>2.39</td>
      <td>5167033</td>
    </tr>
    <tr>
      <th>2008-2-5</th>
      <td>2.34</td>
      <td>2.49</td>
      <td>2.19</td>
      <td>2.42</td>
      <td>4548010</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 01
# MA1赋值:收盘价的5日简单移动平均
# MA2赋值:收盘价的10日简单移动平均
MA1 = stock_data['close'].rolling(window=5).mean()
MA2 = stock_data['close'].rolling(window=10).mean()
```


```python
MA12 = pd.concat([stock_data['close'], MA1, MA2], axis=1)
MA12.columns = ['close','MA1','MA2']
# P01赋值:如果MA1>MA2,返回1,否则返回如果MA2>MA1,返回-1,否则返回0
MA12['P01'] = 0
MA12.loc[MA12['MA1'] > MA12['MA2'],'P01'] = 1
MA12.loc[MA12['MA1'] < MA12['MA2'],'P01'] = -1
# MA1:=MA(CLOSE,5);
# MA2:=MA(CLOSE,10);
# P01:=IF(MA1>MA2,1,IF(MA2>MA1,-1,0));
```


```python
# 02
# MA3赋值:收盘价的3日简单移动平均
# MA4赋值:收盘价的5日简单移动平均
MA3 = stock_data['close'].rolling(window=3).mean()
MA4 = stock_data['close'].rolling(window=5).mean()
```


```python
MA1234 = pd.concat([MA12, MA3, MA4], axis=1)
MA1234.columns = ['close','MA1','MA2','P01','MA3','MA4']
# P02赋值:如果MA3>MA4,返回1,否则返回如果MA4>MA3,返回-1,否则返回0
MA1234['P02'] = 0
MA1234.loc[MA1234['MA3'] > MA1234['MA4'],'P02'] = 1
MA1234.loc[MA1234['MA3'] < MA1234['MA4'],'P02'] = -1
# MA3:=MA(CLOSE,3);
# MA4:=MA(CLOSE,5);
# P02:=IF(MA3>MA4,1,IF(MA4>MA3,-1,0));
```


```python
# 03
# MA5赋值:收盘价的12日简单移动平均
# MA6赋值:收盘价的50日简单移动平均
MA5 = stock_data['close'].rolling(window=12).mean()
MA6 = stock_data['close'].rolling(window=50).mean()
```


```python
MA123456 = pd.concat([MA1234, MA5, MA6], axis=1)
MA123456.columns = ['close','MA1','MA2','P01','MA3','MA4','P02','MA5','MA6']
# P03赋值:如果MA5>MA6,返回1,否则返回如果MA6>MA5,返回-1,否则返回0
MA123456['P03'] = 0
MA123456.loc[MA123456['MA5'] > MA123456['MA6'],'P03'] = 1
MA123456.loc[MA123456['MA5'] < MA123456['MA6'],'P03'] = -1
# MA5:=MA(CLOSE,12);
# MA6:=MA(CLOSE,50);
# P03:=IF(MA5>MA6,1,IF(MA6>MA5,-1,0));
```


```python
# 04
# 5日内最低价的最低值
# 5日内最高价的最高值
LOW5 = stock_data['low'].rolling(window=5).min()
HIGH5 = stock_data['high'].rolling(window=5).max()
```


```python
MAPO_RSV = pd.concat([MA123456, HIGH5, LOW5], axis=1)
MAPO_RSV.columns = ['close','MA1','MA2','P01','MA3','MA4','P02','MA5','MA6','P03','HIGH5','LOW5']
```


```python
# RSV赋值:(收盘价-5日内最低价的最低值)/(5日内最高价的最高值-5日内最低价的最低值)*100
MAPO_RSV['RSV'] = (MAPO_RSV['close']-MAPO_RSV['LOW5'])/(MAPO_RSV['HIGH5']-MAPO_RSV['LOW5'])*100
```


```python
# K赋值:RSVema的3日指数移动平均
# D赋值:K的3日指数移动平均
K = MAPO_RSV['RSV'].ewm(span=3).mean()
D = K.ewm(span=3).mean()
```


```python
MAPO_RSV_KD = pd.concat([MAPO_RSV, K, D], axis=1)
MAPO_RSV_KD.columns = ['close','MA1','MA2','P01','MA3','MA4','P02','MA5','MA6','P03','HIGH5','LOW5','RSV','RSV_K','RSV_D']
# P04赋值:如果K>D,返回1,否则返回如果D>K,返回-1,否则返回0
MAPO_RSV_KD['P04'] =0
MAPO_RSV_KD.loc[MAPO_RSV_KD['RSV_K'] > MAPO_RSV_KD['RSV_D'],'P04'] = 1
MAPO_RSV_KD.loc[MAPO_RSV_KD['RSV_K'] < MAPO_RSV_KD['RSV_D'],'P04'] = -1
# {KDJ}
# RSV:=(CLOSE-LLV(LOW,5))/(HHV(HIGH,5)-LLV(LOW,5))*100;
# K:=EMA(RSV,3);
# D:=EMA(K,3);
# P04:=IF(K>D,1,IF(D>K,-1,0));
```


```python
MAPO_RSV_KD.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>MA1</th>
      <th>MA2</th>
      <th>P01</th>
      <th>MA3</th>
      <th>MA4</th>
      <th>P02</th>
      <th>MA5</th>
      <th>MA6</th>
      <th>P03</th>
      <th>HIGH5</th>
      <th>LOW5</th>
      <th>RSV</th>
      <th>RSV_K</th>
      <th>RSV_D</th>
      <th>P04</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>10.846</td>
      <td>10.467</td>
      <td>1</td>
      <td>10.946667</td>
      <td>10.846</td>
      <td>1</td>
      <td>10.465000</td>
      <td>10.2610</td>
      <td>1</td>
      <td>11.26</td>
      <td>9.93</td>
      <td>90.225564</td>
      <td>81.605946</td>
      <td>77.514414</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>10.936</td>
      <td>10.516</td>
      <td>1</td>
      <td>10.956667</td>
      <td>10.936</td>
      <td>1</td>
      <td>10.512500</td>
      <td>10.2698</td>
      <td>1</td>
      <td>11.26</td>
      <td>10.45</td>
      <td>61.728395</td>
      <td>71.667170</td>
      <td>74.590792</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>10.952</td>
      <td>10.615</td>
      <td>1</td>
      <td>11.016667</td>
      <td>10.952</td>
      <td>1</td>
      <td>10.549167</td>
      <td>10.2794</td>
      <td>1</td>
      <td>11.21</td>
      <td>10.72</td>
      <td>51.020408</td>
      <td>61.343789</td>
      <td>67.967291</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>10.948</td>
      <td>10.702</td>
      <td>1</td>
      <td>10.940000</td>
      <td>10.948</td>
      <td>-1</td>
      <td>10.585833</td>
      <td>10.2886</td>
      <td>1</td>
      <td>11.21</td>
      <td>10.72</td>
      <td>36.734694</td>
      <td>49.039242</td>
      <td>58.503266</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>10.998</td>
      <td>10.812</td>
      <td>1</td>
      <td>10.970000</td>
      <td>10.998</td>
      <td>-1</td>
      <td>10.674167</td>
      <td>10.3018</td>
      <td>1</td>
      <td>11.21</td>
      <td>10.75</td>
      <td>63.043478</td>
      <td>56.041360</td>
      <td>57.272313</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 05
# 收盘价的12日指数移动平均
# 收盘价的26日指数移动平均
EMA12 = stock_data['close'].ewm(span=12).mean()
EMA26 = stock_data['close'].ewm(span=26).mean()
```


```python
EMA1226 = pd.concat([EMA12, EMA26], axis=1)
EMA1226.columns = ['EMA12','EMA26']
# DIF赋值:收盘价的12日指数移动平均-收盘价的26日指数移动平均
EMA1226['DIF'] = EMA1226['EMA12']-EMA1226['EMA26']
```


```python
# DEA赋值:DIF的9日指数移动平均
DEA = EMA1226['DIF'].ewm(span=9).mean()
EMA_DEA = pd.concat([EMA1226, DEA], axis=1)
EMA_DEA.columns = ['EMA12','EMA26','DIF','DEA']
```


```python
# MACD赋值:(DIF-DEA)*2
EMA_DEA['MACD'] = (EMA_DEA['DIF']-EMA_DEA['DEA'])*2
# P05赋值:如果DIF>DEA,返回1,否则返回如果DEA>DIF,返回-1,否则返回0
EMA_DEA['P05'] = 'NaN'
EMA_DEA.loc[EMA_DEA['DIF'] > EMA_DEA['DEA'],'P05'] = 1
EMA_DEA.loc[EMA_DEA['DIF'] < EMA_DEA['DEA'],'P05'] = -1
EMA_DEA.loc[EMA_DEA['DIF'] == EMA_DEA['DEA'],'P05'] = 0
# {MACD}
# DIF:=EMA(CLOSE,12)-EMA(CLOSE,26);
# DEA:=EMA(DIF,9);
# MACD:=(DIF-DEA)*2;
# P05:=IF(DIF>DEA,1,IF(DEA>DIF,-1,0));
```


```python
EMA_DEA.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EMA12</th>
      <th>EMA26</th>
      <th>DIF</th>
      <th>DEA</th>
      <th>MACD</th>
      <th>P05</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.578229</td>
      <td>10.423554</td>
      <td>0.154675</td>
      <td>0.061477</td>
      <td>0.186396</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.635425</td>
      <td>10.462550</td>
      <td>0.172875</td>
      <td>0.083757</td>
      <td>0.178236</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.686898</td>
      <td>10.500139</td>
      <td>0.186759</td>
      <td>0.104357</td>
      <td>0.164804</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.719683</td>
      <td>10.529758</td>
      <td>0.189925</td>
      <td>0.121471</td>
      <td>0.136908</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.768962</td>
      <td>10.567554</td>
      <td>0.201408</td>
      <td>0.137458</td>
      <td>0.127901</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 06
# 【难点：波幅：TR】
# 波幅（true range，TR）与真实波幅（average true range，ATR）的计算
TR = stock_data[['close']].shift(1)
TR.columns = ['Yesterday_Close']
TR = pd.concat([stock_data[['high','low','close']], TR], axis=1)
```


```python
# TR=∣最高价-最低价∣和∣最高价-昨收∣和∣昨收-最低价∣的最大值
TR['TR1'] = np.abs(TR['high']-TR['low'])
TR['TR2'] = np.abs(TR['high']-TR['Yesterday_Close'])
TR['TR3'] = np.abs(TR['Yesterday_Close']-TR['low'])
# 求三者（'TR1','TR2','TR3'）中的最大值
TR['TR12A'] = TR.loc[TR['TR1'] > TR['TR2'],'TR1']
TR['TR12B'] = TR.loc[TR['TR1'] <= TR['TR2'],'TR2']
TR['TR12'] = TR['TR12A'].fillna(0)+TR['TR12B'].fillna(0)
TR['TR123A'] = TR.loc[TR['TR12'] > TR['TR3'],'TR12']
TR['TR123B'] = TR.loc[TR['TR12'] <= TR['TR3'],'TR3']
TR['TR123'] = TR['TR123A'].fillna(0)+TR['TR123B'].fillna(0)
```


```python
TR.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>high</th>
      <th>low</th>
      <th>close</th>
      <th>Yesterday_Close</th>
      <th>TR1</th>
      <th>TR2</th>
      <th>TR3</th>
      <th>TR12A</th>
      <th>TR12B</th>
      <th>TR12</th>
      <th>TR123A</th>
      <th>TR123B</th>
      <th>TR123</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.21</td>
      <td>10.81</td>
      <td>11.13</td>
      <td>10.79</td>
      <td>0.40</td>
      <td>0.42</td>
      <td>0.02</td>
      <td>NaN</td>
      <td>0.42</td>
      <td>0.42</td>
      <td>0.42</td>
      <td>NaN</td>
      <td>0.42</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.20</td>
      <td>10.79</td>
      <td>10.95</td>
      <td>11.13</td>
      <td>0.41</td>
      <td>0.07</td>
      <td>0.34</td>
      <td>0.41</td>
      <td>NaN</td>
      <td>0.41</td>
      <td>0.41</td>
      <td>NaN</td>
      <td>0.41</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>11.02</td>
      <td>10.81</td>
      <td>10.97</td>
      <td>10.95</td>
      <td>0.21</td>
      <td>0.07</td>
      <td>0.14</td>
      <td>0.21</td>
      <td>NaN</td>
      <td>0.21</td>
      <td>0.21</td>
      <td>NaN</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>11.05</td>
      <td>10.75</td>
      <td>10.90</td>
      <td>10.97</td>
      <td>0.30</td>
      <td>0.08</td>
      <td>0.22</td>
      <td>0.30</td>
      <td>NaN</td>
      <td>0.30</td>
      <td>0.30</td>
      <td>NaN</td>
      <td>0.30</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.05</td>
      <td>10.84</td>
      <td>11.04</td>
      <td>10.90</td>
      <td>0.21</td>
      <td>0.15</td>
      <td>0.06</td>
      <td>0.21</td>
      <td>NaN</td>
      <td>0.21</td>
      <td>0.21</td>
      <td>NaN</td>
      <td>0.21</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 求三者（'TR1','TR2','TR3'）或多者中的最大值、最小值的更好的方法
TR_max = TR.loc[:,['TR1','TR2','TR3']]
# TR_max = TR[['TR1','TR2','TR3']] # Is TR_max a view? A copy? Nobody knows!
# SEE:http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
TR_max['TRmax'] = TR_max.apply(lambda x: x.max(), axis=1)
TR_max.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TR1</th>
      <th>TR2</th>
      <th>TR3</th>
      <th>TRmax</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>0.40</td>
      <td>0.42</td>
      <td>0.02</td>
      <td>0.42</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>0.41</td>
      <td>0.07</td>
      <td>0.34</td>
      <td>0.41</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>0.21</td>
      <td>0.07</td>
      <td>0.14</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>0.30</td>
      <td>0.08</td>
      <td>0.22</td>
      <td>0.30</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>0.21</td>
      <td>0.15</td>
      <td>0.06</td>
      <td>0.21</td>
    </tr>
  </tbody>
</table>
</div>




```python
# TRIX赋值:(真实波幅-1日前的真实波幅)/1日前的真实波幅*100
TR['Yesterday_TR'] = TR['TR123'].shift(1)
TR['TRIX'] = (TR['TR123'] - TR['Yesterday_TR'])/TR['Yesterday_TR']*100
TR.loc[0:2,'TRIX'] = 0
```


```python
# MATRIX赋值:TRIX的9日简单移动平均 
MATRIX = TR['TRIX'].rolling(window=9).mean()
TRIX = pd.concat([TR[['TR123','TRIX']], MATRIX], axis=1)
TRIX.columns = ['TR','TRIX','MATRIX']
# P06赋值:如果TRIX>MATRIX,返回1,否则返回如果MATRIX>TRIX,返回-1,否则返回0
TRIX['P06'] = 0
TRIX.loc[TRIX['TRIX'] > TRIX['MATRIX'],'P06'] = 1
TRIX.loc[TRIX['TRIX'] < TRIX['MATRIX'],'P06'] = -1
# {TRIX}
# TRIX:=(TR-REF(TR,1))/REF(TR,1)*100;
# MATRIX:=MA(TRIX,9) ;
# P06:=IF(TRIX>MATRIX,1,IF(MATRIX>TRIX,-1,0));
```


```python
TRIX.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TR</th>
      <th>TRIX</th>
      <th>MATRIX</th>
      <th>P06</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>0.42</td>
      <td>50.000000</td>
      <td>38.002802</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>0.41</td>
      <td>-2.380952</td>
      <td>17.738251</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>0.21</td>
      <td>-48.780488</td>
      <td>3.389626</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>0.30</td>
      <td>42.857143</td>
      <td>16.292344</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>0.21</td>
      <td>-30.000000</td>
      <td>14.193579</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 07
# HD赋值:最高价-1日前的最高价
# LD赋值:1日前的最低价-最低价
HDLD = stock_data[['high','low']].shift(1)
HDLD.columns = ['Yesterday_high','Yesterday_low']
HDLD = pd.concat([stock_data[['high','low','close']], HDLD], axis=1)
HDLD['HD'] = HDLD['high'] - HDLD['Yesterday_high']
HDLD['LD'] = HDLD['Yesterday_low'] - HDLD['low']
```


```python
# DMP赋值:如果HD>0 AND HD>LD,返回HD,否则返回0，的7日指数移动平均
HDLD['DMP'] = 0
HDLD.loc[HDLD['HD'] > HDLD['LD'], 'DMP'] = HDLD['HD']
HDLD.loc[HDLD['HD'] <= 0, 'DMP'] = 0
HDLD['DMP7'] = HDLD['DMP'].ewm(span=7).mean()
```


```python
# DMM赋值:如果LD>0 AND LD>HD,返回LD,否则返回0，的7日指数移动平均
HDLD['DMM'] = 0
HDLD.loc[HDLD['HD'] < HDLD['LD'], 'DMM'] = HDLD['LD']
HDLD.loc[HDLD['LD'] <= 0, 'DMM'] = 0
HDLD['DMM7'] = HDLD['DMM'].ewm(span=7).mean()
```


```python
# PDI赋值: DMP*100/真实波幅
# MDI赋值: DMM*100/真实波幅
HDLD = pd.concat([HDLD,TRIX['TR']], axis=1)
HDLD['PDI'] = HDLD['DMP7']*100/HDLD['TR']
HDLD['MDI'] = HDLD['DMM7']*100/HDLD['TR']
```


```python
# ADX赋值: MDI-PDI的绝对值/(MDI+PDI)*100，的7日指数移动平均
HDLD['ADX'] = np.abs(HDLD['MDI'] - HDLD['PDI'])/(HDLD['MDI'] + HDLD['PDI'])*100
HDLD['ADX7'] = HDLD['ADX'].ewm(span=7).mean()
```


```python
# P07赋值:如果PDI>MDI AND ADX>PDI AND ADX>50,返回3,否则返回如果PDI<MDI AND ADX>MDI AND ADX>50,返回-3,否则返回0
HDLD['P07'] = 0
HDLD.loc[HDLD['PDI'] > HDLD['MDI'], 'P07'] = 3
HDLD.loc[HDLD['PDI'] < HDLD['MDI'], 'P07'] = -3
HDLD.loc[HDLD['PDI'] == HDLD['MDI'], 'P07'] = 0
HDLD.loc[HDLD['ADX7'] <= HDLD['PDI'], 'P07'] = 0
HDLD.loc[HDLD['ADX7'] <= HDLD['MDI'], 'P07'] = 0
HDLD.loc[HDLD['ADX7'] <= 50, 'P07'] = 0
# {DMI}
# HD :=HIGH-REF(HIGH,1);
# LD :=REF(LOW,1)-LOW;
# DMP:=EMA(IF(HD>0 AND HD>LD,HD,0),7);
# DMM:=EMA(IF(LD>0 AND LD>HD,LD,0),7);
# PDI:= DMP*100/TR;
# MDI:= DMM*100/TR;
# ADX:= EMA(ABS(MDI-PDI)/(MDI+PDI)*100,7);
# ADXR:=EMA(ADX,7);
# P07:=IF(PDI>MDI AND ADX>PDI AND ADX>50,3,IF(PDI<MDI AND ADX>MDI AND ADX>50,-3,0));
```


```python
HDLD.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>high</th>
      <th>low</th>
      <th>close</th>
      <th>Yesterday_high</th>
      <th>Yesterday_low</th>
      <th>HD</th>
      <th>LD</th>
      <th>DMP</th>
      <th>DMP7</th>
      <th>DMM</th>
      <th>DMM7</th>
      <th>TR</th>
      <th>PDI</th>
      <th>MDI</th>
      <th>ADX</th>
      <th>ADX7</th>
      <th>P07</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.21</td>
      <td>10.81</td>
      <td>11.13</td>
      <td>11.00</td>
      <td>10.72</td>
      <td>0.21</td>
      <td>-0.09</td>
      <td>0.21</td>
      <td>0.174482</td>
      <td>0.00</td>
      <td>0.060954</td>
      <td>0.42</td>
      <td>41.543217</td>
      <td>14.512825</td>
      <td>48.220301</td>
      <td>47.478235</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.20</td>
      <td>10.79</td>
      <td>10.95</td>
      <td>11.21</td>
      <td>10.81</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>0.130861</td>
      <td>0.02</td>
      <td>0.050715</td>
      <td>0.41</td>
      <td>31.917349</td>
      <td>12.369609</td>
      <td>44.138818</td>
      <td>46.643381</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>11.02</td>
      <td>10.81</td>
      <td>10.97</td>
      <td>11.20</td>
      <td>10.79</td>
      <td>-0.18</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>0.098146</td>
      <td>0.00</td>
      <td>0.038037</td>
      <td>0.21</td>
      <td>46.736119</td>
      <td>18.112642</td>
      <td>44.138818</td>
      <td>46.017240</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>11.05</td>
      <td>10.75</td>
      <td>10.90</td>
      <td>11.02</td>
      <td>10.81</td>
      <td>0.03</td>
      <td>0.06</td>
      <td>0.00</td>
      <td>0.073609</td>
      <td>0.06</td>
      <td>0.043527</td>
      <td>0.30</td>
      <td>24.536462</td>
      <td>14.509137</td>
      <td>25.681064</td>
      <td>40.933196</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.05</td>
      <td>10.84</td>
      <td>11.04</td>
      <td>11.05</td>
      <td>10.75</td>
      <td>0.00</td>
      <td>-0.09</td>
      <td>0.00</td>
      <td>0.055207</td>
      <td>0.00</td>
      <td>0.032646</td>
      <td>0.21</td>
      <td>26.289067</td>
      <td>15.545504</td>
      <td>25.681064</td>
      <td>37.120163</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 08
# LC赋值:1日前的收盘价
LC = stock_data[['close']].shift(1)
LC.columns = ['Yesterday_close']
# RSI赋值:收盘价-LC和0的较大值的5日指数移动平均/收盘价-LC的绝对值的5日指数移动平均*100
LC['LC5'] = 0
LC.loc[stock_data['close'] - LC['Yesterday_close']>0, 'LC5'] = (stock_data['close'] - LC['Yesterday_close'])
LC['RSI5'] = LC['LC5'].ewm(span=5).mean()
LC['ABS'] = np.abs(stock_data['close'] - LC['Yesterday_close'])
LC['ABS5'] = LC['ABS'].ewm(span=5).mean()
RSI = pd.concat([stock_data['close'], LC], axis=1)
RSI['RSI'] = RSI['RSI5']/RSI['ABS5']*100
```


```python
# P08赋值:如果RSI1>80,返回1,否则返回如果RSI1<20,返回-1,否则返回0
RSI['P08'] = 0
RSI.loc[RSI['RSI'] > 80, 'P08'] = 1
RSI.loc[RSI['RSI'] < 20, 'P08'] = -1
# {RSI}
# LC:=REF(CLOSE,1);
# RSI:=EMA(MAX(CLOSE-LC,0),5)/EMA(ABS(CLOSE-LC),5)*100;{10}
# P08:=IF(RSI>80,1,IF(RSI<20,-1,0));
```


```python
RSI.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>Yesterday_close</th>
      <th>LC5</th>
      <th>RSI5</th>
      <th>ABS</th>
      <th>ABS5</th>
      <th>RSI</th>
      <th>P08</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>10.79</td>
      <td>0.34</td>
      <td>0.193503</td>
      <td>0.34</td>
      <td>0.232341</td>
      <td>83.284193</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>11.13</td>
      <td>0.00</td>
      <td>0.129002</td>
      <td>0.18</td>
      <td>0.214894</td>
      <td>60.030613</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>10.95</td>
      <td>0.02</td>
      <td>0.092668</td>
      <td>0.02</td>
      <td>0.149929</td>
      <td>61.807868</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>10.97</td>
      <td>0.00</td>
      <td>0.061779</td>
      <td>0.07</td>
      <td>0.123286</td>
      <td>50.110014</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>10.90</td>
      <td>0.14</td>
      <td>0.087852</td>
      <td>0.14</td>
      <td>0.128857</td>
      <td>68.178038</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 09
# 【难点：平均绝对偏差：mad、AVEDEV】
# TYP赋值:(最高价+最低价+收盘价)/3
TYP = (stock_data['high']+stock_data['low']+stock_data['close'])/3
```


```python
# CCI赋值:(TYP-TYP的8日简单移动平均)/(0.015*TYP的8日平均绝对偏差)
TYP8 = TYP.rolling(window=8).mean()
# 平均绝对偏差的计算方法
mad = lambda x: np.fabs(x-x.mean()).mean()
AVEDEV = TYP.rolling(window=8).apply(mad)
CCI = pd.concat([TYP, TYP8, AVEDEV], axis=1)
CCI.columns = ['TYP','TYP8','AVEDEV']
CCI['CCI'] = (CCI['TYP']-CCI['TYP8'])/(0.015*CCI['AVEDEV'])
```


```python
# P09赋值:如果CCI>180,返回2,否则返回如果CCI<-180,返回-2,否则返回0
CCI['P09'] = 0
CCI.loc[CCI['CCI'] > 180, 'P09'] = 2
CCI.loc[CCI['CCI'] < -180, 'P09'] = -2
# {CCI}
# TYP:=(HIGH+LOW+CLOSE)/3;
# CCI:=(TYP-MA(TYP,8))/(0.015*AVEDEV(TYP,8));
# P09:=IF(CCI>180,2,IF(CCI<-180,-2,0));
```


```python
CCI.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TYP</th>
      <th>TYP8</th>
      <th>AVEDEV</th>
      <th>CCI</th>
      <th>P09</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.050000</td>
      <td>10.459583</td>
      <td>0.475417</td>
      <td>82.792872</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.980000</td>
      <td>10.615417</td>
      <td>0.410729</td>
      <td>59.176600</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.933333</td>
      <td>10.742500</td>
      <td>0.299583</td>
      <td>42.466389</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.900000</td>
      <td>10.861250</td>
      <td>0.137292</td>
      <td>18.816388</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.976667</td>
      <td>10.941250</td>
      <td>0.057083</td>
      <td>41.362530</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 10
# WR赋值:(收盘价-6日内最低价的最低值)/(6日内最高价的最高值-6日内最低价的最低值)*100
LOW6 = stock_data['low'].rolling(window=6).min()
HIGH6 = stock_data['high'].rolling(window=6).max()
WR = pd.concat([stock_data['close'], HIGH6, LOW6], axis=1)
WR.columns = ['close','HIGH6','LOW6']
WR['WR'] = (WR['close']-WR['LOW6'])/(WR['HIGH6']-WR['LOW6'])*100
```


```python
# P10赋值: 如果WR>80,返回1,否则返回如果WR<20,返回-1,否则返回0
WR['P10'] = 0
WR.loc[WR['WR'] > 80, 'P10'] = 1
WR.loc[WR['WR'] < 20, 'P10'] = -1
# {WR}
# WR:=(CLOSE-LLV(LOW,6))/(HHV(HIGH,6)-LLV(LOW,6))*100;
# P10:= IF(WR>80,1,IF(WR<20,-1,0));
```


```python
WR.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>HIGH6</th>
      <th>LOW6</th>
      <th>WR</th>
      <th>P10</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>11.26</td>
      <td>9.79</td>
      <td>91.156463</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>11.26</td>
      <td>9.93</td>
      <td>76.691729</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>11.26</td>
      <td>10.45</td>
      <td>64.197531</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>11.21</td>
      <td>10.72</td>
      <td>36.734694</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>11.21</td>
      <td>10.72</td>
      <td>65.306122</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 11
# OSC赋值:100*(收盘价-收盘价的20日简单移动平均)
MA20 = stock_data['close'].rolling(window=20).mean()
OSC = pd.concat([stock_data['close'], MA20], axis=1)
OSC.columns = ['close','MA20']
OSC['OSC'] = 100*(OSC['close']-OSC['MA20'])
# P11赋值:如果OSC>0,返回1,否则返回如果OSC<0,返回-1,否则返回0
OSC['P11'] = 0
OSC.loc[OSC['OSC'] > 0, 'P11'] = 1
OSC.loc[OSC['OSC'] < 0, 'P11'] = -1
# {OSC}
# OSC:=100*(CLOSE-MA(CLOSE,20));
# P11:=IF(OSC>0,1,IF(OSC<0,-1,0));
```


```python
OSC.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>MA20</th>
      <th>OSC</th>
      <th>P11</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>10.4115</td>
      <td>71.85</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>10.4570</td>
      <td>49.30</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>10.4895</td>
      <td>48.05</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>10.5215</td>
      <td>37.85</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>10.5585</td>
      <td>48.15</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 12
# MOM赋值:收盘价-7日前的收盘价
MOM = stock_data.loc[:,['close']]
MOM['Day7'] = MOM['close'].shift(7)
MOM['MOM'] = MOM['close']-MOM['Day7']
# P12赋值:如果MOM>0,返回1,否则返回如果MOM<0,返回-1,否则返回0
MOM['P12'] = 0
MOM.loc[MOM['MOM'] > 0, 'P12'] = 1
MOM.loc[MOM['MOM'] < 0, 'P12'] = -1
# {MOM}
# MOM:=CLOSE-REF(CLOSE,7);
# P12:=IF(MOM>0,1,IF(MOM<0,-1,0));
```


```python
MOM.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>Day7</th>
      <th>MOM</th>
      <th>P12</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>10.03</td>
      <td>1.10</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>9.94</td>
      <td>1.01</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>10.03</td>
      <td>0.94</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>10.50</td>
      <td>0.40</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>10.89</td>
      <td>0.15</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 13
# DPO赋值:收盘价-6日前的收盘价的11日简单移动平均
MA11 = stock_data['close'].rolling(window=11).mean()
DPO = pd.concat([stock_data['close'], MA11], axis=1)
DPO.columns = ['close','MA11']
DPO['MA11_Day6'] = DPO['MA11'].shift(6)
DPO['DPO'] = DPO['close']-DPO['MA11_Day6']
# P13赋值:如果DPO>0,返回1,否则返回如果DPO<0,返回-1,否则返回0
DPO['P13'] = 0
DPO.loc[DPO['DPO'] > 0, 'P13'] = 1
DPO.loc[DPO['DPO'] < 0, 'P13'] = -1
# {DPO}
# DPO:=CLOSE-REF(MA(CLOSE,11),6);
# P13:=IF(DPO>0,1,IF(DPO<0,-1,0));
```


```python
DPO.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>MA11</th>
      <th>MA11_Day6</th>
      <th>DPO</th>
      <th>P13</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>10.472727</td>
      <td>10.304545</td>
      <td>0.825455</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>10.510909</td>
      <td>10.280000</td>
      <td>0.670000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>10.557273</td>
      <td>10.292727</td>
      <td>0.677273</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>10.640909</td>
      <td>10.320909</td>
      <td>0.579091</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>10.732727</td>
      <td>10.365455</td>
      <td>0.674545</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 14
# MB赋值:收盘价的12日简单移动平均
# R赋值:(收盘价-MB)*(收盘价-MB)
MB = stock_data['close'].rolling(window=12).mean()
R = (stock_data['close']-MB)*(stock_data['close']-MB)
# X1赋值:R的12日简单移动平均
# X2赋值:X1的开方
# D1赋值:1
X1 = R.rolling(window=12).mean()
X2 = X1**0.5
D1 = 1
# UPPER赋值:MB+(D1*X2)
# LOWER赋值:MB-(D1*X2)
UPPER = MB+(D1*X2)
LOWER = MB-(D1*X2)
BOLL = pd.concat([stock_data['close'], MB, R, X1, X2, UPPER, LOWER], axis=1)
BOLL.columns = ['close','MB','R','X1','X2','UPPER','LOWER']
# P14赋值:如果收盘价>UPPER,返回2,否则返回如果收盘价<LOWER,返回-2,否则返回0
BOLL['P14'] = 0
BOLL.loc[BOLL['close'] > BOLL['UPPER'], 'P14'] = 2
BOLL.loc[BOLL['close'] < BOLL['LOWER'], 'P14'] = -2
# {BOLL}
# MB:=MA(CLOSE,12);
# R:=(CLOSE-MB)*(CLOSE-MB);
# X1:=MA(R,12);
# X2:=SQRT(X1);
# D1:=1;
# UPPER:=MB+(D1*X2);
# LOWER:=MB-(D1*X2);
# P14:=IF(CLOSE>UPPER,2,IF(CLOSE<LOWER,-2,0));
```


```python
BOLL.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>MB</th>
      <th>R</th>
      <th>X1</th>
      <th>X2</th>
      <th>UPPER</th>
      <th>LOWER</th>
      <th>P14</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>10.465000</td>
      <td>0.442225</td>
      <td>0.144037</td>
      <td>0.379523</td>
      <td>10.844523</td>
      <td>10.085477</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>10.512500</td>
      <td>0.191406</td>
      <td>0.158805</td>
      <td>0.398503</td>
      <td>10.911003</td>
      <td>10.113997</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>10.549167</td>
      <td>0.177101</td>
      <td>0.169091</td>
      <td>0.411206</td>
      <td>10.960373</td>
      <td>10.137961</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>10.585833</td>
      <td>0.098701</td>
      <td>0.176065</td>
      <td>0.419601</td>
      <td>11.005434</td>
      <td>10.166232</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>10.674167</td>
      <td>0.133834</td>
      <td>0.176814</td>
      <td>0.420493</td>
      <td>11.094659</td>
      <td>10.253674</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 15
# BR赋值:0和最高价-1日前的收盘价的较大值的14日累和/0和1日前的收盘价-最低价的较大值的14日累和*100
Day1 = stock_data[['close']].shift(1)
Day1.columns = ['Day1']
BR = pd.concat([stock_data[['high','low']], Day1], axis=1)
BR['high_Day1'] = BR['high']-BR['Day1']
BR['max1'] = 0
BR.loc[BR['high_Day1'] > 0, 'max1'] = BR['high_Day1']
BR['sum14_1'] = BR['max1'].rolling(window=14).sum()
BR['Day1_low'] = BR['Day1']-BR['low']
BR['max2'] = 0
BR.loc[BR['Day1_low'] > 0, 'max2'] = BR['Day1_low']
BR['sum14_2'] = BR['max2'].rolling(window=14).sum()
BR['BR'] = BR['sum14_1']/BR['sum14_2']*100
```


```python
# AR赋值:最高价-开盘价的14日累和/开盘价-最低价的14日累和*100
AR = stock_data.loc[:,['open','high','low']]
AR['high_open'] = AR['high']-AR['open']
AR['sum14_3'] = AR['high_open'].rolling(window=14).sum()
AR['open_loe'] = AR['open']-AR['low']
AR['sum14_4'] = AR['open_loe'].rolling(window=14).sum()
AR['AR'] = AR['sum14_3']/AR['sum14_4']*100
```


```python
BRAR = pd.concat([stock_data[['open','high','low','close']], BR['BR'], AR['AR']], axis=1)
```


```python
# P15赋值:如果BR>350 OR AR>180,返回3,否则返回如果BR<45 OR AR<45,返回-3,否则返回0
BRAR['P15'] = 0
BRAR.loc[BRAR['BR'] > 350, 'P15'] = 3
BRAR.loc[BRAR['AR'] > 180, 'P15'] = 3
BRAR.loc[BRAR['BR'] < 45, 'P15'] = -3
BRAR.loc[BRAR['AR'] < 45, 'P15'] = -3
# {BRAR}
# BR:=SUM(MAX(0,HIGH-REF(CLOSE,1)),14)/SUM(MAX(0,REF(CLOSE,1)-LOW),14)*100;
# AR:=SUM(HIGH-OPEN,14)/SUM(OPEN-LOW,14)*100;
# P15:=IF(BR>350 OR AR>180,3,IF(BR<45 OR AR<45,-3,0));
```


```python
BRAR.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>close</th>
      <th>BR</th>
      <th>AR</th>
      <th>P15</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.85</td>
      <td>11.21</td>
      <td>10.81</td>
      <td>11.13</td>
      <td>115.248227</td>
      <td>114.539007</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>11.20</td>
      <td>10.79</td>
      <td>10.95</td>
      <td>107.357860</td>
      <td>128.888889</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.90</td>
      <td>11.02</td>
      <td>10.81</td>
      <td>10.97</td>
      <td>102.960526</td>
      <td>120.430108</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.84</td>
      <td>11.05</td>
      <td>10.75</td>
      <td>10.90</td>
      <td>95.076923</td>
      <td>121.754386</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.97</td>
      <td>11.05</td>
      <td>10.84</td>
      <td>11.04</td>
      <td>90.095847</td>
      <td>118.014706</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 16
# TH赋值:如果收盘价>1日前的收盘价,返回成交量(手),否则返回0的14日累和
# TL赋值:如果收盘价<1日前的收盘价,返回成交量(手),否则返回0的14日累和
# TQ赋值:如果收盘价=1日前的收盘价,返回成交量(手),否则返回0的14日累和
THLQ = stock_data.loc[:,['close','volume']]
THLQ['Day1'] = THLQ['close'].shift(1)
THLQ['TH'] = 0
THLQ.loc[THLQ['close'] > THLQ['Day1'],'TH'] = THLQ['volume']/100
THLQ['TH14'] = THLQ['TH'].rolling(window=14).sum()
THLQ['TL'] = 0
THLQ.loc[THLQ['close'] < THLQ['Day1'],'TL'] = THLQ['volume']/100
THLQ['TL14'] = THLQ['TL'].rolling(window=14).sum()
THLQ['TQ'] = 0
THLQ.loc[THLQ['close'] == THLQ['Day1'],'TQ'] = THLQ['volume']/100
THLQ['TQ14'] = THLQ['TQ'].rolling(window=14).sum()
# VR赋值:100*(TH*2+TQ)/(TL*2+TQ)
THLQ['VR'] = 100*(THLQ['TH14']*2+THLQ['TQ14'])/(THLQ['TL14']*2+THLQ['TQ14'])
```


```python
# P16赋值:如果VR>350,返回3,否则返回如果VR<45,返回-3,否则返回0
THLQ['P16'] = 0
THLQ.loc[THLQ['VR'] > 350, 'P16'] = 3
THLQ.loc[THLQ['VR'] < 45, 'P16'] = -3
# {VR}
# TH:=SUM(IF(CLOSE>REF(CLOSE,1),VOL,0),14);
# TL:=SUM(IF(CLOSE<REF(CLOSE,1),VOL,0),14);
# TQ:=SUM(IF(CLOSE=REF(CLOSE,1),VOL,0),14);
# VR:=100*(TH*2+TQ)/(TL*2+TQ);
# P16:=IF(VR>350,3,IF(VR<45,-3,0));
```


```python
THLQ.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>volume</th>
      <th>Day1</th>
      <th>TH</th>
      <th>TH14</th>
      <th>TL</th>
      <th>TL14</th>
      <th>TQ</th>
      <th>TQ14</th>
      <th>VR</th>
      <th>P16</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>5522328</td>
      <td>10.79</td>
      <td>55223.28</td>
      <td>385859.75</td>
      <td>0.00</td>
      <td>129486.76</td>
      <td>0.0</td>
      <td>5.093170e-11</td>
      <td>297.991663</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>5426097</td>
      <td>11.13</td>
      <td>0.00</td>
      <td>385859.75</td>
      <td>54260.97</td>
      <td>167434.00</td>
      <td>0.0</td>
      <td>5.093170e-11</td>
      <td>230.454836</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>3206834</td>
      <td>10.95</td>
      <td>32068.34</td>
      <td>417928.09</td>
      <td>0.00</td>
      <td>154428.36</td>
      <td>0.0</td>
      <td>5.093170e-11</td>
      <td>270.629106</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>5214301</td>
      <td>10.97</td>
      <td>0.00</td>
      <td>405837.79</td>
      <td>52143.01</td>
      <td>206571.37</td>
      <td>0.0</td>
      <td>5.093170e-11</td>
      <td>196.463716</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>4861525</td>
      <td>10.90</td>
      <td>48615.25</td>
      <td>408504.40</td>
      <td>0.00</td>
      <td>206571.37</td>
      <td>0.0</td>
      <td>5.093170e-11</td>
      <td>197.754607</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 17
# WVAD赋值:(收盘价-开盘价)/(最高价-最低价)*成交量(手)的6日累和/10000
WVAD = (stock_data['close'] - stock_data['open'])/(stock_data['high'] - stock_data['low'])*(stock_data['volume']/100)
WVAD = pd.concat([stock_data['volume'], WVAD], axis=1)
WVAD.columns = ['volume','WVAD']
WVAD['WVAD6'] = WVAD['WVAD'].rolling(window=6).sum()/10000
# P17赋值:如果WVAD>0,返回1,否则返回如果WVAD<0,返回-1,否则返回0
WVAD['P17'] = 0
WVAD.loc[WVAD['WVAD6'] > 0, 'P17'] = 1
WVAD.loc[WVAD['WVAD6'] < 0, 'P17'] = -1
# {WVAD}
# WVAD:=SUM((CLOSE-OPEN)/(HIGH-LOW)*VOL,6)/10000;
# P17:=IF(WVAD>0,1,IF(WVAD<0,-1,0));
```


```python
WVAD.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>volume</th>
      <th>WVAD</th>
      <th>WVAD6</th>
      <th>P17</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>5522328</td>
      <td>38656.296000</td>
      <td>12.911556</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>5426097</td>
      <td>0.000000</td>
      <td>12.269036</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>3206834</td>
      <td>10689.446667</td>
      <td>8.750761</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>5214301</td>
      <td>10428.602000</td>
      <td>5.873126</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>4861525</td>
      <td>16205.083333</td>
      <td>6.195331</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 18
# VOLUME赋值:成交量(手)的4日简单移动平均/成交量(手)
VOLUME = stock_data[['volume']].rolling(window=4).mean()
VOLUME['VOL'] = VOLUME['volume']/stock_data['volume']
# MID赋值:100*(最高价+最低价-1日前的最高价+最低价)/(最高价+最低价)
MID = stock_data[['high','low']].shift(1)
MID['MID'] = 100*(stock_data['high']+stock_data['low']-MID['high']-MID['low'])/(stock_data['high']+stock_data['low'])
# EMV赋值:MID*VOLUME*(最高价-最低价)/最高价-最低价的4日简单移动平均的4日简单移动平均
EMV = pd.concat([VOLUME['VOL'], MID['MID']], axis=1)
EMV['high_low'] = stock_data['high']-stock_data['low']
EMV['high_low_4'] = EMV['high_low'].rolling(window=4).mean()
EMV['MID_VOLUME'] = EMV['MID']*EMV['VOL']*EMV['high_low']/EMV['high_low_4']
EMV['MID_VOLUME_4'] = EMV['MID_VOLUME'].rolling(window=4).mean()
```


```python
# P18赋值:如果EMV>0,返回1,否则返回如果EMV<0,返回-1,否则返回0
EMV['P18'] = 0
EMV.loc[EMV['MID_VOLUME_4'] > 0, 'P18'] = 1
EMV.loc[EMV['MID_VOLUME_4'] < 0, 'P18'] = -1
# {EMV}
# VOLUME:=MA(VOL,4)/VOL;
# MID:=100*(HIGH+LOW-REF(HIGH+LOW,1))/(HIGH+LOW);
# EMV:=MA(MID*VOLUME*(HIGH-LOW)/MA(HIGH-LOW,4),4);
# P18:=IF(EMV>0,1,IF(EMV<0,-1,0));
```


```python
EMV.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VOL</th>
      <th>MID</th>
      <th>high_low</th>
      <th>high_low_4</th>
      <th>MID_VOLUME</th>
      <th>MID_VOLUME_4</th>
      <th>P18</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>1.034566</td>
      <td>1.362398</td>
      <td>0.40</td>
      <td>0.4675</td>
      <td>1.205981</td>
      <td>1.509805</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>0.927756</td>
      <td>-0.136426</td>
      <td>0.41</td>
      <td>0.3675</td>
      <td>-0.141207</td>
      <td>0.153775</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>1.339036</td>
      <td>-0.732936</td>
      <td>0.21</td>
      <td>0.3250</td>
      <td>-0.634154</td>
      <td>-0.255648</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>0.928675</td>
      <td>-0.137615</td>
      <td>0.30</td>
      <td>0.3300</td>
      <td>-0.116181</td>
      <td>0.078610</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>0.962083</td>
      <td>0.411147</td>
      <td>0.21</td>
      <td>0.2825</td>
      <td>0.294042</td>
      <td>-0.149375</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 19
# VA赋值:如果收盘价>1日前的收盘价,返回成交量(手),否则返回-成交量(手)
OBV = stock_data[['close']].shift(1)
va = stock_data['close'][0]
OBV.loc[0:1,'close'] = va
OBV['VA'] = stock_data['volume']/100
OBV.loc[stock_data['close'] <= OBV['close'],'VA'] = -1*stock_data['volume']/100
# OBV赋值:如果收盘价=1日前的收盘价,返回0,否则返回VA的历史累和
OBV['OBV_VA'] = OBV['VA']
OBV.loc[stock_data['close'] == OBV['close'],'OBV_VA'] = 0
OBV['OBV'] = OBV['OBV_VA'].cumsum()
# MAOBV赋值:OBV的24日指数移动平均
OBV['MAOBV'] = OBV['OBV'].ewm(span=24).mean()
```


```python
# P19赋值:如果OBV>MAOBV,返回1,否则返回如果OBV<MAOBV,返回-1,否则返回0
OBV['P19'] = 0
OBV.loc[OBV['OBV'] > OBV['MAOBV'], 'P19'] = 1
OBV.loc[OBV['OBV'] < OBV['MAOBV'], 'P19'] = -1
# {OBV}
# VA:=IF(CLOSE>REF(CLOSE,1),VOL,-VOL);
# OBV:=SUM(IF(CLOSE=REF(CLOSE,1),0,VA),0);
# MAOBV:=EMA(OBV,24);
# P19:=IF(OBV>MAOBV,1,IF(OBV<MAOBV,-1,0));
```


```python
OBV.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>VA</th>
      <th>OBV_VA</th>
      <th>OBV</th>
      <th>MAOBV</th>
      <th>P19</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.79</td>
      <td>55223.28</td>
      <td>55223.28</td>
      <td>13404602.04</td>
      <td>1.319030e+07</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.13</td>
      <td>-54260.97</td>
      <td>-54260.97</td>
      <td>13350341.07</td>
      <td>1.320311e+07</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.95</td>
      <td>32068.34</td>
      <td>32068.34</td>
      <td>13382409.41</td>
      <td>1.321745e+07</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.97</td>
      <td>-52143.01</td>
      <td>-52143.01</td>
      <td>13330266.40</td>
      <td>1.322648e+07</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.90</td>
      <td>48615.25</td>
      <td>48615.25</td>
      <td>13378881.65</td>
      <td>1.323867e+07</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 20
# PVI赋值:PVI
PVI = stock_data[['close','volume']].shift(1)
PVI['CLS'] = (stock_data['close']-PVI['close'])/PVI['close']
PVI['vol'] = stock_data['volume']-PVI['volume']
PVI['PV'] = 1
PVI.loc[stock_data['volume']-PVI['volume'] > 0,'PV'] = (PVI['CLS']+1)
PVI['PVI'] = PVI['PV'].cumprod()*100
```


```python
# MPVI赋值:PVI的24日指数移动平均
PVI['MPVI'] = PVI['PVI'].ewm(span=24).mean()
# P20赋值:如果PVI>MPVI,返回1,否则返回如果PVI<MPVI,返回-1,否则返回0
PVI['P20'] = 0
PVI.loc[PVI['PVI'] > PVI['MPVI'], 'P20'] = 1
PVI.loc[PVI['PVI'] < PVI['MPVI'], 'P20'] = -1
# {PVI}
# PVI:=PVI,COLORWHITE;
# MPVI:=EMA(PVI,24),COLORYELLOW;
# P20:=IF(PVI>MPVI,1,IF(PVI<MPVI,-1,0));
```


```python
PVI.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>volume</th>
      <th>CLS</th>
      <th>vol</th>
      <th>PV</th>
      <th>PVI</th>
      <th>MPVI</th>
      <th>P20</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.79</td>
      <td>3021010.0</td>
      <td>0.031511</td>
      <td>2501318.0</td>
      <td>1.031511</td>
      <td>1.174803e+06</td>
      <td>1.076048e+06</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.13</td>
      <td>5522328.0</td>
      <td>-0.016173</td>
      <td>-96231.0</td>
      <td>1.000000</td>
      <td>1.174803e+06</td>
      <td>1.083948e+06</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.95</td>
      <td>5426097.0</td>
      <td>0.001826</td>
      <td>-2219263.0</td>
      <td>1.000000</td>
      <td>1.174803e+06</td>
      <td>1.091217e+06</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.97</td>
      <td>3206834.0</td>
      <td>-0.006381</td>
      <td>2007467.0</td>
      <td>0.993619</td>
      <td>1.167307e+06</td>
      <td>1.097304e+06</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.90</td>
      <td>5214301.0</td>
      <td>0.012844</td>
      <td>-352776.0</td>
      <td>1.000000</td>
      <td>1.167307e+06</td>
      <td>1.102904e+06</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 21
# NVI赋值:NVI
NVI = PVI.loc[:,['close','volume','CLS','vol']]
NVI['NV'] = 1
NVI.loc[stock_data['volume']-NVI['volume'] < 0,'NV'] = (NVI['CLS']+1)
NVI['NVI'] = NVI['NV'].cumprod()*100
```


```python
# MNVI赋值:NVI的24日指数移动平均
NVI['MNVI'] = NVI['NVI'].ewm(span=24).mean()
# P21赋值:如果NVI>MNVI,返回2,否则返回如果NVI<MNVI,返回-2,否则返回0
NVI['P21'] = 0
NVI.loc[NVI['NVI'] > NVI['MNVI'], 'P21'] = 2
NVI.loc[NVI['NVI'] < NVI['MNVI'], 'P21'] = -2
# {NVI}
# NVI:=NVI,COLORWHITE;
# MNVI:=EMA(NVI,24),COLORYELLOW;
# P21:=IF(NVI>MNVI,2,IF(NVI<MNVI,-2,0));
```


```python
NVI.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>volume</th>
      <th>CLS</th>
      <th>vol</th>
      <th>NV</th>
      <th>NVI</th>
      <th>MNVI</th>
      <th>P21</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.79</td>
      <td>3021010.0</td>
      <td>0.031511</td>
      <td>2501318.0</td>
      <td>1.000000</td>
      <td>0.036160</td>
      <td>0.037035</td>
      <td>-2</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.13</td>
      <td>5522328.0</td>
      <td>-0.016173</td>
      <td>-96231.0</td>
      <td>0.983827</td>
      <td>0.035575</td>
      <td>0.036918</td>
      <td>-2</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.95</td>
      <td>5426097.0</td>
      <td>0.001826</td>
      <td>-2219263.0</td>
      <td>1.001826</td>
      <td>0.035640</td>
      <td>0.036816</td>
      <td>-2</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.97</td>
      <td>3206834.0</td>
      <td>-0.006381</td>
      <td>2007467.0</td>
      <td>1.000000</td>
      <td>0.035640</td>
      <td>0.036722</td>
      <td>-2</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.90</td>
      <td>5214301.0</td>
      <td>0.012844</td>
      <td>-352776.0</td>
      <td>1.012844</td>
      <td>0.036098</td>
      <td>0.036672</td>
      <td>-2</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 22
# MASS赋值:最高价-最低价的9日简单移动平均/最高价-最低价的9日简单移动平均的9日简单移动平均的25日累和
MASS = stock_data.loc[:,['high','low']]
MASS['high_low'] = MASS['high']-MASS['low']
MASS['high_low_9'] = MASS['high_low'].rolling(window=9).mean()
MASS['high_low_99'] = MASS['high_low_9'].rolling(window=9).mean()
MASS['high_low_sum'] = MASS['high_low_9']/MASS['high_low_99']
MASS['sum25'] = MASS['high_low_sum'].rolling(window=25).sum()
# MA9赋值:收盘价的9日简单移动平均
MASS['MA9'] = stock_data['close'].rolling(window=9).mean()
MASS['MA9_day1'] = MASS['MA9'].shift(1)
```


```python
# P22赋值:如果MA9>1日前的MA9 AND MASS>26.5,返回2,否则返回如果MA9<1日前的MA9 AND MASS<26.5,返回-2,否则返回0
MASS['P221'] = 0
MASS['P222'] = 0
MASS.loc[MASS['MA9'] > MASS['MA9_day1'], 'P221'] = 2
MASS.loc[MASS['sum25'] <= 26.5, 'P221'] = 0
MASS.loc[MASS['MA9'] <= MASS['MA9_day1'], 'P222'] = -2
MASS.loc[MASS['sum25'] > 26.5, 'P222'] = 0
MASS['P22'] = MASS['P221']+MASS['P222']
# {MASS}
# MASS:=SUM(MA(HIGH-LOW,9)/MA(MA(HIGH-LOW,9),9),25);
# MA9:=MA(CLOSE,9);
# P22:=IF(MA9>REF(MA9,1) AND MASS>26.5,2,IF(MA9<REF(MA9,1) AND MASS<26.5,-2,0));
```


```python
MASS.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>high</th>
      <th>low</th>
      <th>high_low</th>
      <th>high_low_9</th>
      <th>high_low_99</th>
      <th>high_low_sum</th>
      <th>sum25</th>
      <th>MA9</th>
      <th>MA9_day1</th>
      <th>P221</th>
      <th>P222</th>
      <th>P22</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.21</td>
      <td>10.81</td>
      <td>0.40</td>
      <td>0.511111</td>
      <td>0.432716</td>
      <td>1.181170</td>
      <td>30.852381</td>
      <td>10.467778</td>
      <td>10.393333</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.20</td>
      <td>10.79</td>
      <td>0.41</td>
      <td>0.494444</td>
      <td>0.457160</td>
      <td>1.081555</td>
      <td>31.065084</td>
      <td>10.575556</td>
      <td>10.467778</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>11.02</td>
      <td>10.81</td>
      <td>0.21</td>
      <td>0.405556</td>
      <td>0.460370</td>
      <td>0.880933</td>
      <td>31.130989</td>
      <td>10.680000</td>
      <td>10.575556</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>11.05</td>
      <td>10.75</td>
      <td>0.30</td>
      <td>0.408889</td>
      <td>0.461728</td>
      <td>0.885561</td>
      <td>31.192606</td>
      <td>10.786667</td>
      <td>10.680000</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.05</td>
      <td>10.84</td>
      <td>0.21</td>
      <td>0.405556</td>
      <td>0.463210</td>
      <td>0.875533</td>
      <td>31.232696</td>
      <td>10.898889</td>
      <td>10.786667</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 23
# NUM赋值:15日内最高价的最高值-15日内最低价的最低值的绝对值
NUM = stock_data.loc[:,['high','low']]
NUM['high15'] = NUM['high'].rolling(window=15).max()
NUM['low15'] = NUM['low'].rolling(window=15).min()
NUM['NUM'] = np.abs(NUM['high15']-NUM['low15'])
# DEN赋值:收盘价-1日前的收盘价的绝对值的15日累和
DEN = stock_data[['close']].shift(1)
DEN['DEN_abs'] = np.abs(stock_data['close'] - DEN['close'])
DEN['DEN'] = DEN['DEN_abs'].rolling(window=15).sum()
# VHF赋值:如果DEN=0,返回0,否则返回NUM/DEN
# VHF1赋值:VHF的240日指数移动平均
VHF = pd.concat([NUM['NUM'], DEN['DEN']], axis=1)
VHF['VHF'] = 0
VHF.loc[VHF['DEN'] <> 0,'VHF'] = VHF['NUM']/VHF['DEN']
VHF['VHF1'] = VHF['VHF'].ewm(span=240).mean()
```


```python
# P23赋值:如果VHF>VHF1,返回1,否则返回如果VHF<VHF1,返回-1,否则返回0
VHF['P23'] = 0
VHF.loc[VHF['VHF'] > VHF['VHF1'], 'P23'] = 1
VHF.loc[VHF['VHF'] < VHF['VHF1'], 'P23'] = -1
# {VHF}
# NUM:=ABS(HHV(HIGH,15)-LLV(LOW,15));
# DEN:=SUM(ABS(CLOSE-REF(CLOSE,1)),15);
# VHF:=IF(DEN=0,0,NUM/DEN);
# VHF1:=EMA(VHF,240);
# P23:=IF(VHF>VHF1,1,IF(VHF<VHF1,-1,0));
```


```python
VHF.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NUM</th>
      <th>DEN</th>
      <th>VHF</th>
      <th>VHF1</th>
      <th>P23</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>2.18</td>
      <td>2.75</td>
      <td>0.792727</td>
      <td>0.571737</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>2.18</td>
      <td>2.71</td>
      <td>0.804428</td>
      <td>0.573668</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>2.18</td>
      <td>2.58</td>
      <td>0.844961</td>
      <td>0.575919</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>2.18</td>
      <td>2.58</td>
      <td>0.844961</td>
      <td>0.578152</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>2.18</td>
      <td>2.70</td>
      <td>0.807407</td>
      <td>0.580055</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 24
# PU赋值:收盘价的13日简单移动平均
# CU赋值:成交量(手)的13日简单移动平均
# PU1赋值:(PU-1日前的PU)/1日前的PU*100
# CU1赋值:(CU-1日前的CU)/1日前的CU*100
PU = stock_data['close'].rolling(window=13).mean()
CU = (stock_data['volume']/100).rolling(window=13).mean()
PU1 = (PU-PU.shift(1))/PU.shift(1)*100
CU1 = (CU-CU.shift(1))/CU.shift(1)*100
PUCU = pd.concat([PU, CU, PU1, CU1], axis=1)
PUCU.columns = ['PU','CU','PU1','CU1']
# 逆时针曲线赋值:PU1+CU1
PUCU['NSZ'] = PUCU['PU1']+PUCU['CU1']
PUCU['NSZ1'] = PUCU['NSZ'].shift(1)
```


```python
# P24赋值:如果逆时针曲线>1日前的逆时针曲线,返回1,否则返回如果逆时针曲线<1日前的逆时针曲线,返回-1,否则返回0
PUCU['P24'] = 0
PUCU.loc[PUCU['NSZ'] > PUCU['NSZ1'], 'P24'] = 1
PUCU.loc[PUCU['NSZ'] < PUCU['NSZ1'], 'P24'] = -1
# {PUCU}
# PU:=MA(CLOSE,13);
# CU:=MA(VOL,13);
# PU1:=(PU-REF(PU,1))/REF(PU,1)*100;
# CU1:=(CU-REF(CU,1))/REF(CU,1)*100;
# NSZ:=PU1+CU1;
# P24:=IF(NSZ>REF(NSZ,1),1,IF(NSZ<REF(NSZ,1),-1,0));
```


```python
PUCU.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PU</th>
      <th>CU</th>
      <th>PU1</th>
      <th>CU1</th>
      <th>NSZ</th>
      <th>NSZ1</th>
      <th>P24</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.456923</td>
      <td>38387.136923</td>
      <td>0.517598</td>
      <td>8.456332</td>
      <td>8.973931</td>
      <td>1.179722</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.502308</td>
      <td>41560.623846</td>
      <td>0.434015</td>
      <td>8.267058</td>
      <td>8.701073</td>
      <td>8.973931</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.547692</td>
      <td>43097.396154</td>
      <td>0.432139</td>
      <td>3.697664</td>
      <td>4.129804</td>
      <td>8.701073</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.576154</td>
      <td>43573.886154</td>
      <td>0.269837</td>
      <td>1.105612</td>
      <td>1.375449</td>
      <td>4.129804</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.620769</td>
      <td>45953.726154</td>
      <td>0.421849</td>
      <td>5.461620</td>
      <td>5.883469</td>
      <td>1.375449</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 25
# LC2赋值:1日前的收盘价
# AA赋值:最高价-LC2的绝对值
# BB赋值:最低价-LC2的绝对值
# CC赋值:最高价-1日前的最低价的绝对值
# DD赋值:LC2-1日前的开盘价的绝对值
MASI = stock_data[['close']].shift(1)
MASI.columns = ['LC2']
c1 = stock_data['close'][0]
l1 = stock_data['low'][0]
o1 = stock_data['open'][0]
MASI = MASI[['LC2']].fillna(c1)
MASI['AA'] = np.abs(stock_data['high']-MASI['LC2'])
MASI['BB'] = np.abs(stock_data['low']-MASI['LC2'])
MASI['CC'] = np.abs(stock_data['high']-stock_data['low'].shift(1).fillna(l1))
MASI['DD'] = np.abs(MASI['LC2']-stock_data['open'].shift(1).fillna(o1))
```


```python
# R2赋值:如果AA>BB AND AA>CC,返回AA+BB/2+DD/4,否则返回如果BB>CC AND BB>AA,返回BB+AA/2+DD/4,否则返回CC+DD/4
MASI['R2'] = MASI['CC']+MASI['DD']/4
MASI.loc[(MASI['AA']>MASI['BB']) & (MASI['AA']>MASI['CC']),'R2'] = MASI['AA']+MASI['BB']/2+MASI['DD']/4
MASI.loc[(MASI['R2'] == MASI['CC']+MASI['DD']/4) & (MASI['BB']>MASI['CC']) & (MASI['BB']>MASI['AA']),'R2'] = MASI['BB']+MASI['AA']/2+MASI['DD']/4
# X01赋值:(收盘价-LC2+(收盘价-开盘价)/2+LC2-1日前的开盘价)
MASI['X01'] = (stock_data['close']-MASI['LC2']+(stock_data['close']-stock_data['open'])/2+MASI['LC2']-stock_data['open'].shift(1).fillna(o1))
# SI赋值:16*X01/R2*AA和BB的较大值
MASI['AABB'] = MASI[['AA','BB']].apply(lambda x: x.max(), axis=1)
MASI['SI'] = 16*MASI['X01']/MASI['R2']*MASI['AABB']
# ASI赋值:SI的历史累和
MASI['ASI'] = MASI['SI'].cumsum()
# MASI赋值:ASI的6日简单移动平均
MASI['MASI'] = MASI['ASI'].rolling(window=6).mean()
```


```python
# P25赋值:如果收盘价<13日内收盘价的最高值 AND ASI=13日内ASI的最高值,返回1,
# 否则返回如果收盘价>13日内收盘价的最低值 AND ASI=13日内ASI的最低值,返回-1,否则返回0
MASI['P25'] = 0
MASI['close13_max'] = stock_data['close'].rolling(window=13).max()
MASI['close13_min'] = stock_data['close'].rolling(window=13).min()
MASI['ASI_max'] = MASI['ASI'].rolling(window=13).max()
MASI['ASI_min'] = MASI['ASI'].rolling(window=13).min()
MASI.loc[(stock_data['close']<MASI['close13_max']) & (MASI['ASI'] == MASI['ASI_max']),'P25'] = 1
MASI.loc[(stock_data['close']>MASI['close13_min']) & (MASI['ASI'] == MASI['ASI_min']),'P25'] = -1
```


```python
# {ASI}
# LC2:=REF(CLOSE,1);
# AA:=ABS(HIGH-LC2);
# BB:=ABS(LOW-LC2);
# CC:=ABS(HIGH-REF(LOW,1));
# DD:=ABS(LC2-REF(OPEN,1));
# R2:=IF(AA>BB AND AA>CC,AA+BB/2+DD/4,IF(BB>CC AND BB>AA,BB+AA/2+DD/4,CC+DD/4));
# X01:=(CLOSE-LC2+(CLOSE-OPEN)/2+LC2-REF(OPEN,1));
# SI:=16*X01/R2*MAX(AA,BB);
# ASI:=SUM(SI,0),COLORWHITE;
# MASI:=MA(ASI,6),COLORYELLOW;
# P25:=IF(CLOSE<HHV(CLOSE,13) AND ASI=HHV(ASI,13),1,IF(CLOSE>LLV(CLOSE,13) AND ASI=LLV(ASI,13),-1,0));
```


```python
MASI.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LC2</th>
      <th>AA</th>
      <th>BB</th>
      <th>CC</th>
      <th>DD</th>
      <th>R2</th>
      <th>X01</th>
      <th>AABB</th>
      <th>SI</th>
      <th>ASI</th>
      <th>MASI</th>
      <th>P25</th>
      <th>close13_max</th>
      <th>close13_min</th>
      <th>ASI_max</th>
      <th>ASI_min</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.79</td>
      <td>0.42</td>
      <td>0.02</td>
      <td>0.49</td>
      <td>0.13</td>
      <td>0.5225</td>
      <td>0.350</td>
      <td>0.42</td>
      <td>4.501435</td>
      <td>-263.807748</td>
      <td>-272.639239</td>
      <td>0</td>
      <td>11.13</td>
      <td>9.94</td>
      <td>-263.807748</td>
      <td>-288.132182</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>11.13</td>
      <td>0.07</td>
      <td>0.34</td>
      <td>0.39</td>
      <td>0.28</td>
      <td>0.4600</td>
      <td>0.100</td>
      <td>0.34</td>
      <td>1.182609</td>
      <td>-262.625139</td>
      <td>-268.409118</td>
      <td>1</td>
      <td>11.13</td>
      <td>9.94</td>
      <td>-262.625139</td>
      <td>-288.132182</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.95</td>
      <td>0.07</td>
      <td>0.14</td>
      <td>0.23</td>
      <td>0.00</td>
      <td>0.2300</td>
      <td>0.055</td>
      <td>0.14</td>
      <td>0.535652</td>
      <td>-262.089487</td>
      <td>-265.560957</td>
      <td>1</td>
      <td>11.13</td>
      <td>9.94</td>
      <td>-262.089487</td>
      <td>-288.132182</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.97</td>
      <td>0.08</td>
      <td>0.22</td>
      <td>0.24</td>
      <td>0.07</td>
      <td>0.2575</td>
      <td>0.030</td>
      <td>0.22</td>
      <td>0.410097</td>
      <td>-261.679390</td>
      <td>-264.234124</td>
      <td>1</td>
      <td>11.13</td>
      <td>9.94</td>
      <td>-261.679390</td>
      <td>-288.132182</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.90</td>
      <td>0.15</td>
      <td>0.06</td>
      <td>0.30</td>
      <td>0.06</td>
      <td>0.3150</td>
      <td>0.235</td>
      <td>0.15</td>
      <td>1.790476</td>
      <td>-259.888914</td>
      <td>-263.066643</td>
      <td>1</td>
      <td>11.13</td>
      <td>9.94</td>
      <td>-259.888914</td>
      <td>-288.132182</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 26
# BIAS赋值:(收盘价-收盘价的12日简单移动平均)/收盘价的12日简单移动平均*100
BIAS = stock_data[['close']].rolling(window=12).mean()
BIAS.columns = ['MA12']
BIAS['BIAS'] = (stock_data['close']-BIAS['MA12'])/BIAS['MA12']*100
# P26赋值:如果BIAS>10,返回1,否则返回如果BIAS<-10,返回-1,否则返回0
BIAS['P26'] = 0
BIAS.loc[BIAS['BIAS'] > 10, 'P26'] = 1
BIAS.loc[BIAS['BIAS'] < -10, 'P26'] = -1
# {BIAS}
# BIAS:=(CLOSE-MA(CLOSE,12))/MA(CLOSE,12)*100;
# P26:=IF(BIAS>10,1,IF(BIAS<-10,-1,0));
```


```python
BIAS.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MA12</th>
      <th>BIAS</th>
      <th>P26</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>10.465000</td>
      <td>6.354515</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.512500</td>
      <td>4.161712</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.549167</td>
      <td>3.989257</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.585833</td>
      <td>2.967803</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>10.674167</td>
      <td>3.427278</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 输出决策曲线: (36+P01+P02+P03+P04+P05+P06+P07+P08+P09+P10+P11+P12+P13+P14+P15+P16+P17+P18+P19+P20+P21+P22+P23+P24+P25+P26)*1.36
Decision = (MAPO_RSV_KD['P01']+MAPO_RSV_KD['P02']+MAPO_RSV_KD['P03']+MAPO_RSV_KD['P04']
            +EMA_DEA['P05']+TRIX['P06']+HDLD['P07']+RSI['P08']+CCI['P09']+WR['P10']
            +OSC['P11']+MOM['P12']+DPO['P13']+BOLL['P14']+BRAR['P15']+THLQ['P16']+WVAD['P17']+EMV['P18']+OBV['P19']
            +PVI['P20']+NVI['P21']+MASS['P22']+VHF['P23']+PUCU['P24']+MASI['P25']+BIAS['P26']+36)*1.36
```


```python
# 输出MAJCQX:决策曲线的3日简单移动平均
MAJCQX = Decision.rolling(window=3).mean()
Risk_Ratio = pd.concat([stock_data['close'],Decision, MAJCQX], axis=1)
Risk_Ratio.columns = ['close','Decision','MAJCQX']
```


```python
Risk_Ratio.tail()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>Decision</th>
      <th>MAJCQX</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-7-27</th>
      <td>11.13</td>
      <td>74.8</td>
      <td>70.720000</td>
    </tr>
    <tr>
      <th>2017-7-28</th>
      <td>10.95</td>
      <td>65.28</td>
      <td>68.000000</td>
    </tr>
    <tr>
      <th>2017-7-31</th>
      <td>10.97</td>
      <td>62.56</td>
      <td>67.546667</td>
    </tr>
    <tr>
      <th>2017-8-1</th>
      <td>10.90</td>
      <td>62.56</td>
      <td>63.466667</td>
    </tr>
    <tr>
      <th>2017-8-2</th>
      <td>11.04</td>
      <td>59.84</td>
      <td>61.653333</td>
    </tr>
  </tbody>
</table>
</div>


